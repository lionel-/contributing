
# (PART) Getting started {-}

# Cloning the R sources

## Fetch R from a git clone

R is hosted on the [Subversion](https://en.wikipedia.org/wiki/Apache_Subversion) (SVN) version control system. In the age of github and gitlab, this can be a hindrance for most new developers who are only familiar with git workflows. Fortunately, it is easy to work on R from a git clone of the SVN repository. Since SVN does not have a concept of pull requests, contributions are communicated via ordinary patches which are easy to create from git commits and git branches.

Start by cloning R from Winston Chang's [git mirror](https://github.com/wch/r-source) of the Subversion repository:

```sh
git clone https://github.com/wch/r-source.git
```


## Tweak the repository {#sec:tweak-repo}

Next we need to import a few files that will make it easier to build R from the git clone.


### Script for `SVN-REVISION` generation

As of revision [62183](https://github.com/wch/r-source/commit/4f13e532), R must either be built from an SVN checkout or from the tarball generated by `make dist`. This is because R needs to create a file called `SVN-REVISION` that contains information about the last update to the sources. To work around this, we need to augment the build system with:

- `make-svn-revision` generates the `SVN-REVISION` file.

- `GNUmakefile` intercepts the logic that checks for an SVN checkout.

The following commands download the files into a `build` subdirectory.

```sh
mkdir r-source/build
cd r-source/build

wget https://raw.githubusercontent.com/lionel-/contributing/master/inst/GNUmakefile
wget https://raw.githubusercontent.com/lionel-/contributing/master/inst/make-svn-revision

chmod +x make-svn-revision
```


### `.gitignore` file {#sec:gitignore}

Finally, we need to git-ignore a few files that are generated as part of the build process. The following `.gitignore` file should get you covered:

```
.gitignore
build/
src/library/Recommended/*gz
```

This file ignores itself, anything that is in the `build` directory, and the tarballs of the recommended packages.


# Building R

## Autotools

If you have ever compiled an open source project from scratch, you should be familiar with the file layout of `r-source`:

```sh
ls
#> COPYING         Makefile.fw     VERSION-NICK    doc/            share/
#> ChangeLog       Makefile.in     config.site     etc/            src/
#> INSTALL         README          configure       m4/             tests/
#> Makeconf.in     VERSION         configure.ac    po/             tools/
```

R is configured for your system and built into binaries using the [Autotools](https://en.wikipedia.org/wiki/GNU_Build_System) build system. Two important Autotools files are:

* `configure`: This is an executable script that configures the build system for your particular machine.

* `Makefile.in`: From this template, the configure script creates a `Makefile`. This file contains instructions for the command `make`, which is the workhorse of a build system.

Normally you build open source softwares with the following incantation (do not run this just yet, wait after reading about the build directory in the next sections):

```sh
./configure && make && make install
```

For building R you need an additional step. First install the recommended packages:

```sh
# Download recommended packages
tools/rsync-recommended

./configure && make all && make install
```


## The build directory {#sec:build}

Running `configure` and `make` inside the root directory of the R sources is not very practical because they create files all over the place. These files can't be gitignored effectively and will get in the way of your workflow. To avoid littering the repository with generated files, we are going to build R from a separate directory.

The build directory can in principle be created anywhere you like. We recommend always creating it inside the root directory as `build`. If you have followed the instructions in [Tweak the repository](#sec:tweak-repo), it should already be created and gitignored.

Always call the configure script from inside the build directory:

```sh
cd build
../configure
```

This should take a couple of minutes. Once configured, your build directory looks like this:

```sh
ls
#> Makeconf                Makefrag.m              libconftest.dSYM/       src/
#> Makefile                config.log              libtool                 tests/
#> Makefrag.cc             config.status           m4/                     tools/
#> Makefrag.cc_lo          doc/                    po/
#> Makefrag.cxx            etc/                    share/
```

You'll recognise the `Makefile` file we mentioned earlier. You'll also find several directories mirroring the file hierarchy from the root folder. The most important are `src` and `tests`. These directories contain makefiles of their own:

```sh
ls src
#> Makefile        extra/          library/        modules/        scripts/
#> appl/           include/        main/           nmath/          unix/

ls tests
#> Embedding/      Examples/       Makefile
```

Given the similarity of the file hierarchies it is easy to confuse the __root__ and __build__ directories.

* The root directory contains all the sources, saved outputs for unit tests, and other revisioned files. You will develop from the root directory.

* The build directory contains all the makefiles that allow you to interact with the build system. From the build directory you'll build R, recompile parts of R, run tests, etc.


## Location of installation

We have run `configure` but we haven't specified any parameter. You can discover all the supported options with:

```sh
../configure --help
```

One important parameter is the location where you'd like to install R. It is normally decided by the `--prefix=path` argument.

```sh
../configure --prefix=/usr/local
```

On macOS systems it is often more practical to install R as an application framework. In that case, supply `--enable-R-framework` instead of `--prefix`. The advantage of installing as a framework is that you can use the convenient [RSwitch](https://rud.is/rswitch/) dropdown menu to switch to the development version.

```sh
../configure --enable-R-framework
```


## Environment variables

`configure --help` lists all influential environment variables. You can set envvars by passing them to the configure script. For instance, we might want to set `CFLAGS` to enable debugging symbols and disable compiler optimisations. This considerably improves the debugging experience:

```sh
../configure CFLAGS="-g -O0"
```

Other important envvars are:

* `CPPFLAGS` and `LDFLAGS`. By default they point to `/usr/local/include` and `/usr/local/lib`. On macOS systems, this is where libraries installed with `brew` are linked.

* `CC` which points to `gcc` by default. On macOS systems, this is an alias for the system `clang`.


## Making R on macOS

I personally use the [following script](https://raw.githubusercontent.com/lionel-/contributing/master/inst/build.sh) to build R on macOS. It should be run from the build directory, and the build directory should be a folder inside the root directory:

```sh
#!/bin/bash


# R recommends setting this to avoid issues with programs like sed:
export LANG=C

export R_ARCH=""

# Get version in major.minor format:
VERSION=`sed 's/\([0-9]*.[0-9]*\).[0-9]*.*/\1/' ../VERSION`

# Use version-dev as default folder target:
TARGET=${1:-$VERSION-dev}


# Download recommended packages
../tools/rsync-recommended

../configure \
    --enable-R-framework FW_VERSION=${TARGET} \
    --with-aqua=yes \
    --with-x=yes \
    --enable-memory-profiling \
    CFLAGS="-g -O0" && \
  make all && \
  make install
```

This script:

* Installs R as an application framework whose version is suffixed with `-dev`. The suffix is useful if you'd like to install a patched version of an already released R. If you're working exclusively on the development version, this is not as useful since the framework is set to the next unreleased version and cannot interfere with your regular installations.

* Installs the recommended packages. These packages are needed for running unit tests.

* Enables Aqua and X. This adds some compilation time but is useful if you plan to use the development version for actual data analysis or if you'd like to patch the graphical devices.

* Enables the R memory profiler.

* Sets `CFLAGS` to include debugging symbols and disable optimisations.

* Runs `make all` to build R and `make install` to install it as a framework.

The framework is automatically enabled after `make install`. You should get the following disclaimer if you run R:

```sh
R --version
#> R Under development (unstable) (2019-09-12 r77181) -- "Unsuffered Consequences"
#> Copyright (C) 2019 The R Foundation for Statistical Computing
#> Platform: x86_64-apple-darwin18.0.0 (64-bit)
```

### Compilation troubleshooting

*   liblzma library and headers are required

    ```sh
    brew install xz
    ```

*   zlib library and headers are required

    ```sh
    brew install zlib
    ```

*   configure error: cannot run C compiled programs

    ```sh
    xcode-select --install
    ```

*   libcurl >= 7.28.0 library and headers are required with support for https

    Take anaconda off of your PATH ([SO](https://stackoverflow.com/a/51318770)).
